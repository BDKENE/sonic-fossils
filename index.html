<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Towards Sonic Fossils ‚Äì Record & Archive</title>
  <style>
    :root{
      --ink:#222; --sun:#ffcb6b; --sky:#2979ff; --coral:#ff7043; --mint:#21c7a8; --paper:#fff8e1;
    }
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--ink);text-align:center;background:
      radial-gradient(80vw 80vw at -10% -20%, #fff1c7 0%, transparent 60%),
      radial-gradient(60vw 60vw at 110% -10%, #e7f0ff 0%, transparent 60%),
      linear-gradient(180deg,#fffdf7,#ffffff);}
    header{position:relative;padding:48px 20px 28px;background:var(--sun);border-bottom:4px solid #333;box-shadow:0 4px 0 #333;}
    header:after{content:"";position:absolute;left:0;right:0;bottom:-14px;height:14px;background:repeating-linear-gradient(90deg,transparent 0 18px,rgba(0,0,0,.08) 18px 22px);}
    h1{font-size:2rem;margin:0 0 6px}
    header p{margin:0;color:#4a3b1a}

    .btn{background:var(--sky);color:#fff;border:none;border-radius:14px;padding:14px 26px;margin:10px;cursor:pointer;font-size:1rem;box-shadow:0 6px 0 #1c54b2;transition:.15s transform ease,.15s box-shadow ease}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 0 #1c54b2}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:0 6px 0 #96b7ff}
    .btn.alt{background:var(--coral);box-shadow:0 6px 0 #c94f2c}
    .btn.ghost{background:#fff;color:var(--ink);border:2px solid var(--ink);box-shadow:0 6px 0 #bdbdbd}

    .wrap{max-width:980px;margin:32px auto;padding:0 20px}

    .panel{background:#fff;border:3px solid #333;border-radius:24px;box-shadow:8px 8px 0 #333;padding:22px;margin:18px auto;position:relative}
    .panel .badge{position:absolute;left:-10px;top:-12px;background:#fff;border:2px solid #333;border-radius:999px;padding:6px 12px;font-weight:700;transform:rotate(-8deg)}

    .indicator{display:none;margin-top:10px;font-weight:800;font-size:1.1rem;color:#d32f2f}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#d32f2f;margin-right:8px;animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

    .bars{height:42px;display:flex;align-items:flex-end;gap:6px;justify-content:center;margin:14px 0}
    .bar{width:6px;background:linear-gradient(180deg,var(--mint),#7ee7d8);border-radius:6px;height:6px;opacity:.3;transition:height .2s ease,opacity .2s ease}
    .bars.active .bar{opacity:1}
    .bars.active .bar:nth-child(1){animation:wv 0.6s ease-in-out infinite}
    .bars.active .bar:nth-child(2){animation:wv 0.55s ease-in-out infinite .05s}
    .bars.active .bar:nth-child(3){animation:wv 0.5s ease-in-out infinite .1s}
    .bars.active .bar:nth-child(4){animation:wv 0.55s ease-in-out infinite .15s}
    .bars.active .bar:nth-child(5){animation:wv 0.6s ease-in-out infinite .2s}
    @keyframes wv{0%{height:8px}50%{height:42px}100%{height:8px}}

    audio{width:100%;margin-top:10px}
    .list{margin:26px 0}
    .card{background:var(--paper);border:2px solid #ffb74d;border-radius:18px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:16px 16px 12px;text-align:left;position:relative}
    .card + .card{margin-top:14px}

    .confetti{position:fixed;inset:0;pointer-events:none}
    .piece{position:absolute;width:8px;height:12px;background:var(--sun);top:-20px;opacity:.9;transform:rotate(10deg)}

    .hint{color:#666;margin:12px 0 4px}

    /* illustration */
    .illustration{display:block;width:100%;max-width:100%;height:auto;border:2px solid #333;border-radius:14px;margin:10px 0 6px;box-shadow:0 4px 0 #333}
    .desc{font-size:.95rem;color:#333;margin:6px 0 0}
  </style>
</head>
<body>
  <header>
    <h1>üéß Towards Sonic Fossils ‚Äì Elephant & Castle Edition</h1>
    <p>Speak, record, and leave your voice fossil in the city.</p>
    <button class="btn" id="scrollBtn">Start</button>
  </header>

  <div class="wrap">
    <!-- LISTEN -->
    <section class="panel">
      <div class="badge">LISTEN DECK</div>
      <h2 style="margin:6px 0 8px">Listen to Sonic Layers</h2>
      <p class="hint">Explore Elephant & Castle‚Äôs soundscape through two layers: <b>Past</b> and <b>Present</b>.</p>

      <!-- PAST -->
      <div class="card" id="pastCard">
        <strong>Past ‚Äî Trocadero Cinema & Market Streets</strong>
        <img id="pastImg" class="illustration" alt="Historic illustration" src="" />
        <div style="display:flex;align-items:center;gap:10px;margin-top:8px;justify-content:center">
          <button class="btn ghost" id="pastPrev">‚óÄ</button>
          <span id="pastLabel">Track 1/2 ¬∑ Rudy Lewis, organ ‚Äî Trocadero Cinema</span>
          <button class="btn ghost" id="pastNext">‚ñ∂</button>
        </div>
        <audio id="pastAudio" controls style="margin-top:8px"></audio>
        <p class="desc" id="pastDesc"></p>
      </div>

      <!-- PRESENT -->
      <div class="card" id="presentCard">
        <strong>Present ‚Äî Students, Streets, Transit</strong>
        <div style="display:flex;align-items:center;gap:10px;margin-top:8px;justify-content:center">
          <button class="btn ghost" id="presentPrev">‚óÄ</button>
          <span id="presentLabel">Track 1/2 ¬∑ UAL Students‚Äô Canteen</span>
          <button class="btn ghost" id="presentNext">‚ñ∂</button>
        </div>
        <audio id="presentAudio" controls style="margin-top:8px"></audio>
        <p class="desc" id="presentDesc"></p>
      </div>
    </section>

    <!-- RECORD -->
    <section class="panel" aria-live="polite">
      <div class="badge">REC STATION</div>
      <h2 style="margin:6px 0 4px">Record & Contribute</h2>
      <p class="hint">Tap <b>Start Recording</b>, speak for a few seconds, then stop to add your sound to the archive.</p>

      <div style="margin:12px 0">
        <button class="btn alt" id="startBtn">üéôÔ∏è Start Recording</button>
        <button class="btn ghost" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>

      <div class="indicator" id="recordingText"><span class="dot"></span>Recording‚Ä¶ Speak now!</div>

      <div class="bars" id="bars" aria-hidden="true">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </section>

    <!-- ARCHIVE -->
    <section class="panel">
      <div class="badge">ARCHIVE FEED</div>
      <div id="audioContainer" class="list"></div>
      <p class="hint">Your latest recording appears at the top. Files stay in this browser for demo purposes.</p>
    </section>
  </div>

  <canvas class="confetti" id="confetti"></canvas>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recordingText = document.getElementById('recordingText');
    const bars = document.getElementById('bars');
    const audioContainer = document.getElementById('audioContainer');
    const scrollBtn = document.getElementById('scrollBtn');

    // deck elements
    const pastAudioEl = document.getElementById('pastAudio');
    const pastLabelEl = document.getElementById('pastLabel');
    const pastImgEl   = document.getElementById('pastImg');
    const pastDescEl  = document.getElementById('pastDesc');

    const presentAudioEl = document.getElementById('presentAudio');
    const presentLabelEl = document.getElementById('presentLabel');
    const presentDescEl  = document.getElementById('presentDesc');

    let mediaRecorder; let chunks = []; let streamRef=null;
    let pastIdx=0; let presentIdx=0;

    scrollBtn.onclick = () => window.scrollTo({top:document.body.clientHeight*0.25,behavior:'smooth'});

    // --- Listen Deck data (Elephant & Castle) ---
    const pastTracks = [
      {
        title: 'Rudy Lewis, organ ‚Äî BBC Broadcast, Trocadero Cinema',
        url: './audio/rudy-lewis-trocadero.mp3',
        img: './img/trocadero-cinema.png',
        desc: 'Historic broadcast ambience from the former Trocadero Cinema at Elephant & Castle, recalling large hall acoustics and organ resonance.'
      },
      {
        title: 'Market Traders‚Äô Shouts ‚Äî Elephant Shopping Centre',
        url: './audio/elephant-shopping-centre.mp3',
        img: './img/elephant-shopping-centre.png',
        desc: 'Indoor shopping centre ambience of its time: dense, modern retail noise, overlapping voices, and constant movement.'
      }
    ];

    const presentTracks = [
      {
        title: 'UAL Students‚Äô Canteen',
        url: './audio/ual-canteen.mp3',
        desc: 'Everyday student life: trays, chatter, and bursts of conversation in a shared space.'
      },
      {
        title: 'Construction Site',
        url: './audio/construction-site.mp3',
        desc: 'Contemporary urban change: machinery, metal impacts, and intermittent signals marking the city‚Äôs transformation.'
      }
    ];

    function renderDeck(prefix){
      if(prefix==='past'){
        const it = pastTracks[pastIdx];
        pastAudioEl.src = it.url;
        pastLabelEl.textContent = `Track ${pastIdx+1}/${pastTracks.length} ¬∑ ${it.title}`;
        pastImgEl.src = it.img || '';
        pastImgEl.style.display = it.img ? 'block' : 'none';
        pastDescEl.textContent = it.desc || '';
      } else {
        const it = presentTracks[presentIdx];
        presentAudioEl.src = it.url;
        presentLabelEl.textContent = `Track ${presentIdx+1}/${presentTracks.length} ¬∑ ${it.title}`;
        presentDescEl.textContent = it.desc || '';
      }
    }

    document.getElementById('pastPrev').onclick = ()=>{ pastIdx=(pastIdx-1+pastTracks.length)%pastTracks.length; renderDeck('past'); pastAudioEl.play(); };
    document.getElementById('pastNext').onclick = ()=>{ pastIdx=(pastIdx+1)%pastTracks.length; renderDeck('past'); pastAudioEl.play(); };
    document.getElementById('presentPrev').onclick = ()=>{ presentIdx=(presentIdx-1+presentTracks.length)%presentTracks.length; renderDeck('present'); presentAudioEl.play(); };
    document.getElementById('presentNext').onclick = ()=>{ presentIdx=(presentIdx+1)%presentTracks.length; renderDeck('present'); presentAudioEl.play(); };

    renderDeck('past'); renderDeck('present');

    function confettiBurst(){
      const c = document.getElementById('confetti');
      const ctx = c.getContext('2d');
      c.width = window.innerWidth; c.height = window.innerHeight;
      const pieces = Array.from({length:50}).map(()=>({
        x:Math.random()*c.width, y:-10-Math.random()*40, vy:2+Math.random()*3, vx:(Math.random()-.5)*2, s:6+Math.random()*8, a:Math.random()*Math.PI
      }));
      let frames=0;
      function draw(){
        ctx.clearRect(0,0,c.width,c.height);
        pieces.forEach(p=>{p.y+=p.vy; p.x+=p.vx; p.a+=.1;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle = ['#ffcb6b','#2979ff','#21c7a8','#ff7043'][Math.floor(Math.random()*4)];
          ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
        });
        frames++; if(frames<90) requestAnimationFrame(draw); else ctx.clearRect(0,0,c.width,c.height);
      }
      draw();
    }

    async function startRecording(){
      try{
        streamRef = await navigator.mediaDevices.getUserMedia({audio:true});
        const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
        mediaRecorder = new MediaRecorder(streamRef,{mimeType:mime});
        chunks = [];
        mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: chunks[0]?.type || 'audio/webm' });
          const url = URL.createObjectURL(blob);
          addCard(url);
          confettiBurst();
          if(streamRef){ streamRef.getTracks().forEach(tr=>tr.stop()); streamRef=null; }
        };
        mediaRecorder.start();
        recordingText.style.display='inline-block';
        bars.classList.add('active');
        startBtn.disabled=true; stopBtn.disabled=false;
      }catch(err){
        alert('Microphone permission is needed to record.');
        console.error(err);
      }
    }

    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state !== 'inactive'){
        mediaRecorder.stop();
      }
      recordingText.style.display='none';
      bars.classList.remove('active');
      startBtn.disabled=false; stopBtn.disabled=true;
    }

    function addCard(url,label){
      const card = document.createElement('div');
      card.className = 'card';
      const title = label || 'New Sound Added to Archive';
      card.innerHTML = `<strong>${title}</strong>`;
      const audio = document.createElement('audio');
      audio.controls = true; audio.src = url; audio.setAttribute('aria-label','Recording playback');

      const actions = document.createElement('div');
      actions.style.marginTop='8px';

      const dl = document.createElement('a');
      dl.textContent = '‚¨áÔ∏è Download';
      dl.download = `recording-${Date.now()}.webm`;
      dl.href = url; dl.style.marginRight='12px';

      const del = document.createElement('button');
      del.className='btn ghost'; del.textContent='üóë Delete'; del.onclick=()=> card.remove();

      actions.appendChild(dl); actions.appendChild(del);
      card.appendChild(audio);
      card.appendChild(actions);
      audioContainer.prepend(card);
    }

    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    // Pre-seeded demo cards (ÂèØ‰øùÁïô/Âà†Êéâ)
    window.addEventListener('DOMContentLoaded', ()=>{
      const seeded = [
        { title:'Resident Memory ‚Äì Walworth Road', url:'./audio/ual-canteen.mp3' },
        { title:'Student Note ‚Äì Lunch Break', url:'./audio/elephant-shopping-centre.mp3' }
      ];
      seeded.forEach(item=> addCard(item.url, item.title));
    });
  </script>
</body>
</html>
